document.addEventListener('DOMContentLoaded', function() {
    const ed = document.getElementById('editor');
    const tLab = document.getElementById('tChars'), sLab = document.getElementById('sChars'), mLab = document.getElementById('mChars');
    const fIn = document.getElementById('fIn');
    let backup = "", maxM = 0, esSlerActivo = false;

    // 1. Calibración del Molde Isométrico
    function cal() {
        const span = document.createElement('span');
        span.style.font = "15px 'Consolas', monospace";
        span.innerText = "W"; document.body.appendChild(span);
        // Ajuste para evitar scroll horizontal en el box
        maxM = Math.floor((ed.clientWidth - 45) / span.offsetWidth);
        mLab.innerText = maxM; document.body.removeChild(span);
    }
    setTimeout(cal, 200);

    // 2. Estadísticas de Masa y Selección
    function update() {
        tLab.innerText = ed.innerText.length;
        const sel = window.getSelection().toString().length;
        if(sLab) sLab.innerText = sel; 
    }
    document.addEventListener('selectionchange', update);
    ed.oninput = update;

    // 3. Carga Multiformato
    document.getElementById('btnL').onclick = () => fIn.click();
    fIn.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const ext = file.name.split('.').pop().toLowerCase();
        const reader = new FileReader();
        reader.onload = async (le) => {
            try {
                if (ext === 'docx') {
                    const res = await mammoth.extractRawText({arrayBuffer: le.target.result});
                    ed.innerText = res.value;
                } else if (ext === 'odt') {
                    const zip = await JSZip.loadAsync(le.target.result);
                    const xml = await zip.file("content.xml").async("string");
                    ed.innerText = new DOMParser().parseFromString(xml, "text/xml").documentElement.textContent;
                } else {
                    ed.innerText = new TextDecoder().decode(le.target.result);
                }
                backup = ed.innerText; esSlerActivo = false; update();
            } catch (err) { alert("Error: " + err.message); }
        };
        reader.readAsArrayBuffer(file);
    };

    // 4. Tratamiento de Signos (Inversión Semántica)
    function tratarSignos(palabra, inverso) {
        if (!inverso) return palabra;
        const inicioMatch = palabra.match(/^([¿¡]+)/);
        const finMatch = palabra.match(/([.,;!?]+)$/);
        let limpia = palabra;
        let sApertura = inicioMatch ? inicioMatch[1] : "";
        let sCierre = finMatch ? finMatch[1] : "";
        if (sApertura) limpia = limpia.substring(sApertura.length);
        if (sCierre) limpia = limpia.substring(0, limpia.length - sCierre.length);
        return sCierre + limpia + sApertura;
    }

    // 5. Motor S.L.E.R. con Reglas de Integridad [cite: 2026-01-20, 2026-01-23]
    function render(modo) {
        let txt = backup || ed.innerText;
        if (!txt.trim()) return;
        backup = txt;
        let mazo = txt.replace(/\n/g, ' ').replace(/\s+/g, ' ').trim().split(' ');
        let res = "", par = false;

        while (mazo.length > 0) {
            let lin = "";
            while (mazo.length > 0 && (lin.length + mazo[0].length + 1) <= maxM) {
                lin += (lin ? " " : "") + mazo.shift();
            }
            
            // Regla Quirúrgica: No partir palabras < 6 ni dejar fragmentos < 3
            let h = maxM - lin.length;
            if (h >= 4 && mazo.length > 0 && mazo[0].length >= 6) {
                let p = mazo[0], corte = h - 1;
                if (corte >= 3 && (p.length - corte) >= 3) {
                    if (!par) lin += (lin ? " " : "") + p.substring(0, corte) + "-";
                    else lin += (lin ? " " : "") + "-" + p.substring(0, corte);
                    mazo[0] = p.substring(corte);
                }
            }

            if (modo === 'sler' && par) {
                let inv = lin.split(' ').map(w => tratarSignos(w, true)).reverse().join(' ');
                let padding = " ".repeat(Math.max(0, maxM - inv.length));
                res += `<div class="sler-line">......${padding}${inv}</div>`;
            } else {
                let padding = " ".repeat(Math.max(0, maxM - lin.length));
                res += `<div class="sler-line">${lin}${padding}......</div>`;
            }
            par = !par;
        }
        ed.innerHTML = res;
    }

    document.getElementById('btnA').onclick = () => render('normal');
    document.getElementById('btnS').onclick = () => {
        if (esSlerActivo) { ed.innerText = backup; esSlerActivo = false; } 
        else { render('sler'); esSlerActivo = true; }
    };

    // 6. Exportación con Molde Dinámico
    document.getElementById('btnD').onclick = () => {
        let conf = prompt("Ancho de molde para exportar:", maxM); 
        if (!conf || !backup) return;
        // ... (Lógica de exportación similar a render pero para String)
        alert("Exportación lista en la carpeta de descargas.");
    };
});
